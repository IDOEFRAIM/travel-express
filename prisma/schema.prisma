// --- CONFIGURATION ---

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --- ENUMÉRATIONS ---

enum Role {
  ADMIN
  STUDENT
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  REJECTED
  UNDER_REVIEW
  ACCEPTED
  JW202_RECEIVED
  VISA_GRANTED
  FLIGHT_BOOKED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  PARTIAL
  REFUNDED
}

enum PaymentMethod {
  ORANGE_MONEY
  MOOV_MONEY
  CASH
  TRANSFER
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
}

// --- UTILISATEURS ---

model User {
  id               String        @id @default(cuid())
  email            String        @unique
  password         String 
  fullName         String? 
  phone            String?
  role             Role          @default(STUDENT)
  
  // Profil médical & Documents
  passportNumber   String?       
  specificDiseases String[]      @default([])
  medicalHistory   String[]      @default([]) 
  
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  applications     Application[]
  payments         Payment[]
  activityLogs     ActivityLog[] @relation("AdminActivityLogs")
}

// --- DOSSIERS DE CANDIDATURE ---

model Application {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id])
  
  // Détails de la demande
  country         String            @default("Chine") 
  universityId    String? 
  university      University?       @relation(fields: [universityId], references: [id])
  desiredProgram  String?
  
  // État du dossier (Le Stepper)
  status          ApplicationStatus @default(DRAFT)
  progress        Int               @default(0)
  rejectionReason String?           @db.Text

  // Finances du dossier
  applicationFee  Float             @default(500000)
  
  // Données spécifiques au dossier (pour archivage)
  passportNumber  String?           
  medicalHistory  String?           @db.Text 

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  documents       Document[]
  payments        Payment[]
  paymentStatus PaymentStatus @default(PENDING)
}

// --- UNIVERSITÉS ---

model University {
  id           String        @id @default(cuid())
  name         String
  city         String
  country      String        @default("Chine")
  summary      String?
  description  String?       @db.Text
  costRange    String?
  programs     String?
  images       String[]      // Tableau d'URLs
  imageUrl     String?       // Image principale
  pdfUrl       String?
  createdAt    DateTime      @default(now())

  applications Application[]
  payments     Payment[]
}

// --- DOCUMENTS ---

model Document {
  id            String         @id @default(cuid())
  applicationId String
  application   Application    @relation(fields: [applicationId], references: [id])
  type          String         // Ex: "PASSPORT", "DIPLOMA"
  name          String
  url           String
  status        DocumentStatus @default(PENDING)
  createdAt     DateTime       @default(now())
}

// --- FINANCES ---

model Payment {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id])
  
  applicationId String?       
  application   Application?  @relation(fields: [applicationId], references: [id])
  
  universityId  String?
  university    University?   @relation(fields: [universityId], references: [id])

  amount        Float
  currency      String        @default("XOF")
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  reference     String?       
  createdAt     DateTime      @default(now())
}

model FeesByCountry {
  id        String   @id @default(cuid())
  country   String   @unique 
  amount    Float    
  currency  String   @default("XOF")
  updatedAt DateTime @updatedAt
}

// --- LOGS & ACTIVITÉ ---

model Activity {
  id          String   @id @default(cuid())
  type        String
  title       String
  description String
  date        DateTime @default(now())
  user        String
  color       String
  refId       String?
}

model ActivityLog {
  id          String   @id @default(cuid())
  adminId     String
  action      String
  targetType  String?
  targetId    String?
  details     String?
  createdAt   DateTime @default(now())

  admin       User     @relation("AdminActivityLogs", fields: [adminId], references: [id])
}